<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>File Upload with Alpine.js</title>
    <script
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
  </head>
  <body>
    <div class="container" x-data="fileUploader()" x-init="init()">
      <h1>File Upload</h1>

      <div class="flex-container">
        <!-- Upload Form -->
        <form
          class="form-section"
          @submit.prevent="startUpload"
          enctype="multipart/form-data"
        >
          <label>
            Choose files (<span x-text="files.length"></span>)
            <input type="file" multiple x-ref="fileInput" @change="addFiles" />
          </label>
          <button type="submit" :disabled="isLoading || files.length === 0">
            <template x-if="!isLoading">
              <span>Upload</span>
            </template>
            <template x-if="isLoading">
              <span>Uploading <span class="spinner"></span></span>
            </template>
          </button>
        </form>

        <!-- Upload List -->
        <template x-if="files.length > 0">
          <div class="upload-list list-section">
            <template x-for="(file, index) in files" :key="file.name + index">
              <div
                class="upload-item"
                :class="{ 'duplicate-file': duplicateFiles.includes(file.name) }"
              >
                <div class="file-name-row">
                  <span x-text="file.name"></span>
                  <div class="status-container">
                    <!-- Spinner while uploading -->
                    <template
                      x-if="isLoading && !uploadedFiles.includes(file.name) && !duplicateFiles.includes(file.name)"
                    >
                      <span class="spinner"></span>
                    </template>

                    <!-- Tick after uploaded -->
                    <template x-if="uploadedFiles.includes(file.name)">
                      <span class="status-success">&#10003;</span>
                    </template>

                    <!-- Duplicate warning -->
                    <template x-if="duplicateFiles.includes(file.name)">
                      <span
                        title="Duplicate file - not uploaded"
                        style="color: #c0392b; font-weight: bold"
                        >&#9888;</span
                      >
                    </template>

                    <!-- Remove file (only before upload starts) -->
                    <template
                      x-if="!isLoading && !uploadedFiles.includes(file.name) && !duplicateFiles.includes(file.name)"
                    >
                      <button
                        type="button"
                        class="remove-btn"
                        @click="removeFile(index)"
                        title="Remove file"
                      >
                        &times;
                      </button>
                    </template>
                  </div>
                </div>

                <!-- Progress bar (only for uploading files) -->
                <template
                  x-if="progressMap[file.name] !== undefined && !uploadedFiles.includes(file.name) && !duplicateFiles.includes(file.name)"
                >
                  <div class="progress-bar">
                    <div
                      class="progress-fill"
                      :style="`width: ${progressMap[file.name]}%`"
                    >
                      <span x-text="progressMap[file.name] + '%'"></span>
                    </div>
                  </div>
                </template>
              </div>
            </template>
          </div>
        </template>
      </div>

      <!-- Popup for duplicate file -->
      <template x-if="showPopup">
        <div class="popup">
          <div>
            <strong>File already exists on server:</strong>
            <span x-text="popupFileName"></span>
          </div>
          <button @click="closePopup">OK</button>
        </div>
      </template>
    </div>
  </body>

  <script>
    function fileUploader() {
      return {
        files: [],
        uploadedFiles: [],
        duplicateFiles: [],
        progressMap: {},
        isLoading: false,
        fileQueue: [],
        currentFileIndex: 0,
        showPopup: false,
        popupFileName: "",

        init() {},

        addFiles(event) {
          const selected = Array.from(event.target.files);
          selected.forEach((file) => {
            if (
              !this.files.some((f) => f.name === file.name) &&
              !this.uploadedFiles.includes(file.name) &&
              !this.duplicateFiles.includes(file.name)
            ) {
              this.files.push(file);
            }
          });
          this.$refs.fileInput.value = null;
        },

        removeFile(index) {
          if (this.isLoading) return;
          const removed = this.files.splice(index, 1)[0];
          this.uploadedFiles = this.uploadedFiles.filter(
            (name) => name !== removed.name
          );
          this.duplicateFiles = this.duplicateFiles.filter(
            (name) => name !== removed.name
          );
          delete this.progressMap[removed.name];
        },

        startUpload() {
          if (this.files.length === 0) return;
          this.isLoading = true;
          this.fileQueue = this.files.filter(
            (f) =>
              !this.uploadedFiles.includes(f.name) &&
              !this.duplicateFiles.includes(f.name)
          );
          this.currentFileIndex = 0;
          this.uploadNextFile();
        },

        uploadNextFile() {
          if (this.currentFileIndex >= this.fileQueue.length) {
            this.isLoading = false;
            return;
          }

          const file = this.fileQueue[this.currentFileIndex];
          const formData = new FormData();
          formData.append("files[]", file);

          const xhr = new XMLHttpRequest();
          xhr.open("POST", "http://localhost:5010/upload", true);

          xhr.upload.onprogress = (e) => {
            if (
              e.lengthComputable &&
              !this.duplicateFiles.includes(file.name) &&
              this.progressMap[file.name] !== null
            ) {
              const percent = Math.round((e.loaded / e.total) * 100);
              this.progressMap[file.name] = percent;
            }
          };

          xhr.onload = () => {
            try {
              const response = JSON.parse(xhr.responseText);
              if (response.status === "exists") {
                this.popupFileName = file.name;
                if (!this.duplicateFiles.includes(file.name)) {
                  this.duplicateFiles.push(file.name);
                }
                delete this.progressMap[file.name]; // ðŸ§  Remove progress bar for duplicate
                this.showPopup = true;
              } else if (response.status === "success") {
                this.progressMap[file.name] = 100;
                this.uploadedFiles.push(file.name);
                this.currentFileIndex++;
                setTimeout(() => this.uploadNextFile(), 400);
              } else {
                this.currentFileIndex++;
                this.uploadNextFile();
              }
            } catch (e) {
              this.currentFileIndex++;
              this.uploadNextFile();
            }
          };

          xhr.onerror = () => {
            console.error("Upload failed for", file.name);
            this.currentFileIndex++;
            this.uploadNextFile();
          };

          xhr.send(formData);
        },

        closePopup() {
          this.showPopup = false;
          this.currentFileIndex++;
          setTimeout(() => this.uploadNextFile(), 300);
        },
      };
    }
  </script>

  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .container {
      background: #fff;
      padding: 2rem 3rem;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      max-width: 1000px;
      width: 100%;
    }
    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: #333;
    }
    .flex-container {
      display: flex;
      gap: 2rem;
      align-items: flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .form-section {
      flex: 1 1 45%;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-width: 250px;
    }
    .list-section {
      flex: 1 1 45%;
      min-width: 250px;
      max-height: 400px;
      overflow-y: auto;
      background-color: #fafafa;
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 0.5rem 1rem;
    }
    input[type="file"] {
      border: 2px dashed #a3a3a3;
      padding: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }
    input[type="file"]:hover {
      border-color: #3498db;
    }
    button {
      background-color: #3498db;
      color: white;
      font-weight: 600;
      padding: 0.75rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
    }
    button:disabled {
      background-color: #95c4f2;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #217dbb;
    }
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    .upload-item {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px solid #ddd;
      font-size: 0.95rem;
      color: #444;
    }
    .upload-item:last-child {
      border-bottom: none;
    }
    .file-name-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }
    .progress-bar {
      position: relative;
      height: 20px;
      width: 100%;
      background: #ddd;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 4px;
    }
    .progress-fill {
      height: 100%;
      background-color: #3498db;
      transition: width 0.3s ease;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: 600;
      font-size: 0.85rem;
      user-select: none;
    }
    .remove-btn {
      background: transparent;
      border: none;
      font-size: 20px;
      line-height: 1;
      color: #c0392b;
      cursor: pointer;
      padding: 0 8px;
      user-select: none;
    }
    .remove-btn:hover {
      color: #e74c3c;
    }
    .status-success {
      color: #28a745;
      font-weight: bold;
      font-size: 20px;
      line-height: 1;
    }
    .status-container {
      min-width: 24px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .duplicate-file {
      color: #c0392b !important;
      font-weight: bold;
    }
    .popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #ccc;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 999;
      max-width: 300px;
    }
    .popup button {
      background: #e74c3c;
      color: #fff;
      padding: 4px 10px;
      border-radius: 4px;
      border: none;
      margin-top: 10px;
      cursor: pointer;
    }
    @media (max-width: 768px) {
      .flex-container {
        flex-direction: column;
      }
    }
  </style>
</html>
